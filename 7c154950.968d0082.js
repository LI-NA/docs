(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{149:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return c})),a.d(t,"metadata",(function(){return l})),a.d(t,"rightToc",(function(){return i})),a.d(t,"default",(function(){return b}));var n=a(1),r=a(9),s=(a(0),a(179)),c={id:"ec2-nginx",title:"Self Hosting with EC2 and Nginx",sidebar_label:"Self Hosting with EC2 and Nginx"},l={id:"self-hosting/ec2-nginx",title:"Self Hosting with EC2 and Nginx",description:"These instructions make the following assumptions:",source:"@site/docs/self-hosting/ec2-nginx.md",permalink:"/self-hosting/ec2-nginx",editUrl:"https://github.com/standardnotes/docs/edit/master/docs/self-hosting/ec2-nginx.md",lastUpdatedAt:1580461252,sidebar_label:"Self Hosting with EC2 and Nginx",sidebar:"someSidebar",previous:{title:"Getting Started with Self Hosting",permalink:"/self-hosting/getting-started"},next:{title:"Self Hosting with Docker",permalink:"/self-hosting/docker"}},i=[{value:"Getting started",id:"getting-started",children:[]},{value:"Using your new server",id:"using-your-new-server",children:[]}],o={rightToc:i};function b(e){var t=e.components,a=Object(r.a)(e,["components"]);return Object(s.b)("wrapper",Object(n.a)({},o,a,{components:t,mdxType:"MDXLayout"}),Object(s.b)("p",null,"These instructions make the following assumptions:"),Object(s.b)("ul",null,Object(s.b)("li",{parentName:"ul"},Object(s.b)("p",{parentName:"li"},"You've just finished using the AWS web console to launch an EC2 server with a 64 bit version of Amazon Linux AMI with ",Object(s.b)("strong",{parentName:"p"},"at least 1 GB of memory"),".")),Object(s.b)("li",{parentName:"ul"},Object(s.b)("p",{parentName:"li"},"You've configured your security groups to allow for incoming SSH connections from your local IP.")),Object(s.b)("li",{parentName:"ul"},Object(s.b)("p",{parentName:"li"},"You've configured a domain name (or subdomain) to point to your server's IP address."))),Object(s.b)("h3",{id:"getting-started"},"Getting started"),Object(s.b)("ol",null,Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"SSH into your new server with the keys you should have received after launching an instance:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"ssh -i /path/to/key.pem ec2-user@domain.com\n"))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Update your system:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"sudo yum update\n"))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Install RVM (Ruby Version Manager):"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3\n\n\\curl -sSL https://get.rvm.io | bash -s stable\n"))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Begin using RVM in current session:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"source /home/ec2-user/.rvm/scripts/rvm\n"))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Install Ruby"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"rvm install ruby\n")),Object(s.b)("p",{parentName:"li"},"This should install the latest version of ruby (2.3 at the time of this writing.)"),Object(s.b)("p",{parentName:"li"},Object(s.b)("em",{parentName:"p"},"Note that at least Ruby 2.2.2 is required for Rails 5."))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Use Ruby"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"rvm use ruby\n"))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Install Bundler:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"gem install bundler --no-ri --no-rdoc\n"))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Install MySQL (optional; you can also use a hosted db through Amazon RDS, which is recommended):"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"sudo yum install mysql56-server\nsudo service mysqld start\nsudo mysql_secure_installation\nsudo yum install mysql-devel\nsudo chkconfig mysqld on\n")),Object(s.b)("p",{parentName:"li"},"Create a database:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"mysql -u root -p\n> create database standard_notes;\n> quit;\n")))),Object(s.b)("ol",null,Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Install Passenger:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"sudo yum install rubygems\ngem install rubygems-update --no-rdoc --no-ri\nupdate_rubygems\ngem install passenger --no-rdoc --no-ri\n"))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Remove system Nginx installation if installed (you'll use Passenger's instead):"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"sudo yum remove nginx\nsudo rm -rf /etc/nginx\n"))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Configure Passenger:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),'sudo chmod o+x "/home/ec2-user"\nsudo yum install libcurl-devel\nrvmsudo passenger-install-nginx-module\nrvmsudo passenger-config validate-install\n'))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Install Git:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"sudo yum install git\n"))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Set up HTTPS/SSL for your server (free using LetsEncrypt) (required if using the secure client on ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://app.standardnotes.org"}),"https://app.standardnotes.org"),"):"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"sudo chown ec2-user /opt\ncd /opt\ngit clone https://github.com/letsencrypt/letsencrypt\ncd letsencrypt\n")),Object(s.b)("p",{parentName:"li"},"Run the setup wizard:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"./letsencrypt-auto certonly --standalone --debug\n")),Object(s.b)("p",{parentName:"li"},"Note the location of the certificates, typically ",Object(s.b)("inlineCode",{parentName:"p"},"/etc/letsencrypt/live/domain.com/fullchain.pem")))),Object(s.b)("ol",null,Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Configure Nginx:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"sudo vim /opt/nginx/conf/nginx.conf\n")),Object(s.b)("p",{parentName:"li"},"Add this to the bottom of the file, ",Object(s.b)("em",{parentName:"p"},"inside")," the last curly brace:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-nginx"}),"server {\n    listen 443 ssl default_server;\n    ssl_certificate /etc/letsencrypt/live/domain.com/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/domain.com/privkey.pem;\n    server_name domain.com;\n    passenger_enabled on;\n    passenger_app_env production;\n    root /home/ec2-user/syncing-server/public;\n  }\n")))),Object(s.b)("ol",null,Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Make sure you are in your home directory and clone the Standard Notes ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/standardnotes/syncing-server"}),"syncing-server")," project:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"cd ~\ngit clone https://github.com/standardnotes/syncing-server.git\ncd syncing-server\n"))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Setup project:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"bundle install\nbower install\nrails assets:precompile\n"))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Create a .env file for your environment variables. The Rails app will automatically load these when it starts."),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"vim .env\n")),Object(s.b)("p",{parentName:"li"},"Insert:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),'RAILS_ENV=production\nSECRET_KEY_BASE=use "bundle exec rake secret"\n\nDB_HOST=localhost\nDB_PORT=3306\nDB_DATABASE=standard_notes\nDB_USERNAME=root\nDB_PASSWORD=\n'))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Setup database:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"rails db:migrate\n"))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"Start Nginx:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"sudo /opt/nginx/sbin/nginx\n")),Object(s.b)("p",{parentName:"li"},"Tip: you will need to restart Nginx whenever you make changes to your environment variables or the Nginx configuration:"),Object(s.b)("pre",{parentName:"li"},Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"sudo /opt/nginx/sbin/nginx -s reload\n"))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},"You're done!"))),Object(s.b)("h2",{id:"using-your-new-server"},"Using your new server"),Object(s.b)("p",null,"You can immediately start using your new server by using the Standard Notes app at ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://app.standardnotes.org"}),"https://app.standardnotes.org"),"."),Object(s.b)("p",null,'In the Account menu, enter the address of your new server in "Sync Server Domain" under "Advanced Options".'),Object(s.b)("p",null,"Then, register for a new account, and begin using your private new secure Standard Notes server!"))}b.isMDXComponent=!0},179:function(e,t,a){"use strict";a.d(t,"a",(function(){return p})),a.d(t,"b",(function(){return d}));var n=a(0),r=a.n(n);function s(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function c(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?c(Object(a),!0).forEach((function(t){s(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):c(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var o=r.a.createContext({}),b=function(e){var t=r.a.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):l({},t,{},e)),a},p=function(e){var t=b(e.components);return r.a.createElement(o.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},u=Object(n.forwardRef)((function(e,t){var a=e.components,n=e.mdxType,s=e.originalType,c=e.parentName,o=i(e,["components","mdxType","originalType","parentName"]),p=b(a),u=n,d=p["".concat(c,".").concat(u)]||p[u]||m[u]||s;return a?r.a.createElement(d,l({ref:t},o,{components:a})):r.a.createElement(d,l({ref:t},o))}));function d(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var s=a.length,c=new Array(s);c[0]=u;var l={};for(var i in t)hasOwnProperty.call(t,i)&&(l[i]=t[i]);l.originalType=e,l.mdxType="string"==typeof e?e:n,c[1]=l;for(var o=2;o<s;o++)c[o]=a[o];return r.a.createElement.apply(null,c)}return r.a.createElement.apply(null,a)}u.displayName="MDXCreateElement"}}]);