(window.webpackJsonp=window.webpackJsonp||[]).push([[59],{133:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return i})),n.d(t,"toc",(function(){return o})),n.d(t,"default",(function(){return l}));var a=n(3),r=(n(0),n(177));const s={slug:"ec2-nginx/",id:"ec2-nginx",title:"Self-Hosting with EC2 and Nginx",sidebar_label:"EC2 and Nginx",description:"How to self-host a Standard Notes Sync server with EC2 and Nginx.",keywords:["standard notes","docs","notes app","end-to-end encryption","self-hosting","sync server","ec2 nginx"],image:"/img/logo.png",hide_title:!1,hide_table_of_contents:!1},i={unversionedId:"self-hosting/ec2-nginx",id:"self-hosting/ec2-nginx",isDocsHomePage:!1,title:"Self-Hosting with EC2 and Nginx",description:"How to self-host a Standard Notes Sync server with EC2 and Nginx.",source:"@site/docs/self-hosting/ec2-nginx.md",slug:"/self-hosting/ec2-nginx/",permalink:"/self-hosting/ec2-nginx/",editUrl:"https://github.com/standardnotes/docs/edit/main/docs/self-hosting/ec2-nginx.md",version:"current",lastUpdatedAt:1618352694,formattedLastUpdatedAt:"4/13/2021",sidebar_label:"EC2 and Nginx",sidebar:"technicalSidebar",previous:{title:"Self-Hosting with Heroku",permalink:"/self-hosting/heroku/"},next:{title:"Self-Hosting on a Raspberry Pi",permalink:"/self-hosting/rapberry-pi/"}},o=[{value:"Introduction",id:"introduction",children:[]},{value:"Getting started",id:"getting-started",children:[]},{value:"Using your new server",id:"using-your-new-server",children:[]}],c={toc:o};function l({components:e,...t}){return Object(r.b)("wrapper",Object(a.a)({},c,t,{components:e,mdxType:"MDXLayout"}),Object(r.b)("div",{className:"admonition admonition-caution alert alert--warning"},Object(r.b)("div",{parentName:"div",className:"admonition-heading"},Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",{parentName:"h5",className:"admonition-icon"},Object(r.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},Object(r.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),Object(r.b)("div",{parentName:"div",className:"admonition-content"},Object(r.b)("p",{parentName:"div"},"The docs below are not up-to-date. Please read the ",Object(r.b)("a",{parentName:"p",href:"https://github.com/standardnotes/syncing-server#readme"},"README.md of the syncing-server repository")," for the most up-to-date instructions. Please ",Object(r.b)("a",{parentName:"p",href:"https://github.com/standardnotes/syncing-server/issues"},"open an issue")," if you have any issues."))),Object(r.b)("h2",{id:"introduction"},"Introduction"),Object(r.b)("p",null,"These instructions make the following assumptions:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"You've just finished using the AWS web console to launch an EC2 server with a 64 bit version of Amazon Linux AMI with ",Object(r.b)("strong",{parentName:"li"},"at least 1 GB of memory"),"."),Object(r.b)("li",{parentName:"ul"},"You've configured your security groups to allow for incoming SSH connections from your local IP."),Object(r.b)("li",{parentName:"ul"},"You've configured a domain name (or subdomain) to point to your server's IP address.")),Object(r.b)("h2",{id:"getting-started"},"Getting started"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"SSH into your new server with the keys you should have received after launching an instance:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"ssh -i /path/to/key.pem ec2-user@domain.com\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Update your system:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"sudo yum update\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Install RVM (Ruby Version Manager):"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3\n\n\\curl -sSL https://get.rvm.io | bash -s stable\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Begin using RVM in current session:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"source /home/ec2-user/.rvm/scripts/rvm\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Install Ruby"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"rvm install ruby\n")),Object(r.b)("p",{parentName:"li"},"This should install the latest version of ruby (2.3 at the time of this writing.)"),Object(r.b)("p",{parentName:"li"},Object(r.b)("em",{parentName:"p"},"Note that at least Ruby 2.2.2 is required for Rails 5."))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Use Ruby"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"rvm use ruby\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Install Bundler:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"gem install bundler --no-ri --no-rdoc\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Install MySQL (optional; you can also use a hosted db through Amazon RDS, which is recommended):"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"sudo yum install mysql56-server\nsudo service mysqld start\nsudo mysql_secure_installation\nsudo yum install mysql-devel\nsudo chkconfig mysqld on\n")),Object(r.b)("p",{parentName:"li"},"Create a database:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"mysql -u root -p\n> create database standard_notes;\n> quit;\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Install Passenger:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"sudo yum install rubygems\ngem install rubygems-update --no-rdoc --no-ri\nupdate_rubygems\ngem install passenger --no-rdoc --no-ri\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Remove system Nginx installation if installed (you'll use Passenger's instead):"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"sudo yum remove nginx\nsudo rm -rf /etc/nginx\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Configure Passenger:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},'sudo chmod o+x "/home/ec2-user"\nsudo yum install libcurl-devel\nrvmsudo passenger-install-nginx-module\nrvmsudo passenger-config validate-install\n'))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Install Git:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"sudo yum install git\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Set up HTTPS/SSL for your server (free using LetsEncrypt) (required if using the secure client on ",Object(r.b)("a",{parentName:"p",href:"https://app.standardnotes.org"},"https://app.standardnotes.org"),"):"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"sudo chown ec2-user /opt\ncd /opt\ngit clone https://github.com/letsencrypt/letsencrypt\ncd letsencrypt\n")),Object(r.b)("p",{parentName:"li"},"Run the setup wizard:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"./letsencrypt-auto certonly --standalone --debug\n")),Object(r.b)("p",{parentName:"li"},"Note the location of the certificates, typically ",Object(r.b)("inlineCode",{parentName:"p"},"/etc/letsencrypt/live/domain.com/fullchain.pem"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Configure Nginx:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"sudo vim /opt/nginx/conf/nginx.conf\n")),Object(r.b)("p",{parentName:"li"},"Add this to the bottom of the file, ",Object(r.b)("em",{parentName:"p"},"inside")," the last curly brace:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-nginx"},"server {\n    listen 443 ssl default_server;\n    ssl_certificate /etc/letsencrypt/live/domain.com/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/domain.com/privkey.pem;\n    server_name domain.com;\n    passenger_enabled on;\n    passenger_app_env production;\n    root /home/ec2-user/syncing-server/public;\n  }\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Make sure you are in your home directory and clone the Standard Notes ",Object(r.b)("a",{parentName:"p",href:"https://github.com/standardnotes/syncing-server"},"syncing-server")," project:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"cd ~\ngit clone --single-branch --branch master https://github.com/standardnotes/syncing-server.git\ncd syncing-server\n")))),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"Note:")," The ",Object(r.b)("inlineCode",{parentName:"p"},"master")," branch has the latest, stable code. Use this branch in production environments."),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Setup project:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"bundle install\nrails assets:precompile\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Create a .env file for your environment variables. The Rails app will automatically load these when it starts."),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"vim .env\n")),Object(r.b)("p",{parentName:"li"},"Insert:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},'RAILS_ENV=production\nSECRET_KEY_BASE=use "bundle exec rake secret"\n\nDB_HOST=localhost\nDB_PORT=3306\nDB_DATABASE=standard_notes\nDB_USERNAME=root\nDB_PASSWORD=\n'))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Setup database:"))),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},"rails db:migrate\n")),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Start Nginx:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"sudo /opt/nginx/sbin/nginx\n")),Object(r.b)("p",{parentName:"li"},"Tip: you will need to restart Nginx whenever you make changes to your environment variables or the Nginx configuration:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",{parentName:"pre",className:"language-bash"},"sudo /opt/nginx/sbin/nginx -s reload\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"You're done!"))),Object(r.b)("h2",{id:"using-your-new-server"},"Using your new server"),Object(r.b)("p",null,"You can immediately start using your new server by using the Standard Notes app at ",Object(r.b)("a",{parentName:"p",href:"https://app.standardnotes.org"},"https://app.standardnotes.org"),"."),Object(r.b)("p",null,"In the account menu, choose ",Object(r.b)("inlineCode",{parentName:"p"},"Advanced Options")," and enter the address of your new server in ",Object(r.b)("inlineCode",{parentName:"p"},"Sync Server Domain"),"."),Object(r.b)("p",null,"Then, register for a new account or log into an existing account and begin using your private new secure Standard Notes server!"))}l.isMDXComponent=!0},177:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return d}));var a=n(0),r=n.n(a);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=r.a.createContext({}),b=function(e){var t=r.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=b(e.components);return r.a.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},u=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,s=e.originalType,i=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),p=b(n),u=a,d=p["".concat(i,".").concat(u)]||p[u]||m[u]||s;return n?r.a.createElement(d,o(o({ref:t},l),{},{components:n})):r.a.createElement(d,o({ref:t},l))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=n.length,i=new Array(s);i[0]=u;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o.mdxType="string"==typeof e?e:a,i[1]=o;for(var l=2;l<s;l++)i[l]=n[l];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,n)}u.displayName="MDXCreateElement"}}]);